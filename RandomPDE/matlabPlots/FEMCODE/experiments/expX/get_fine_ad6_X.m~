function [mesh, father] = get_fine_ad6_X(RB)
%GET_FINE_AD3_X Summary of this function goes here
%   Detailed explanation goes here
maxdof = 111230; 
nref = 6;
filename = ['~/repos/anmc_fem/experiments/expX/mesh_fine_ad' num2str(nref) '.mat'];
try
  load(filename,'mesh','father');
catch
  mesh = RB.rmesh;
  [mesh, father] = bisect(mesh, [2,3], RB.R);
  [mesh, father] = uniformrefine(mesh, father);
  mesh = periodize(mesh,[-1/2,1/2,-1/2,1/2]);

  [paramsX, paramsY] = meshgrid(...
    linspace(RB.param.min(1),RB.param.max(1),3), ...
    linspace(RB.param.min(2),RB.param.max(2),3));
  params = [paramsX(:), paramsY(:)];
  NP = size(params,1);
  meshes = cell(NP,1);
  
  % adaptive
  while true
    %% GENERATE MESHES
    
    
    %% SOLVE PROBLEMS
    [usol, ufemspace, psol, pfemspace, mesh, vp] = stokes(mesh, vp);
    ndof = 2*ufemspace.ndof + pfemspace.ndof;
    fprintf('ITER: %d, DOF: %d\n', k, ndof);
    
    %% ESTIMATE
    res = stokes_residual(mesh, vp, ufemspace, usol, pfemspace, psol);
    
    %% STOP?
    if (ndof >= maxdof) 
      break;
    end
    
    %% MARK
    mElements = markelem(res, struct('method','L2','unify',true,'theta',0.25));
    
    %% REFINE
    [mesh, father] = bisect(mesh, mElements, father);
    k=k+1;
  end
  mesh=cleanfields(mesh);
  save(filename,'mesh','father');
end
end

